datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==================== UTILIZADORES ====================

model User {
  id            String    @id @default(cuid())
  email         String?   @unique
  telefone      String?   @unique
  nome          String?
  password      String?   // Hash bcrypt, opcional para convidados
  emailVerified DateTime?
  isGuest       Boolean   @default(false) // Conta de convidado
  role          String    @default("CUSTOMER") // CUSTOMER, STAFF, ADMIN, SUPER_ADMIN
  
  pedidos       Pedido[]
  enderecos     Endereco[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Endereco {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  nome       String   // "Casa", "Trabalho", etc.
  rua        String
  bairro     String
  municipio  String
  provincia  String
  referencia String?  // Ponto de referência
  principal  Boolean  @default(false)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([userId])
}

// ==================== PEDIDOS ====================

model Pedido {
  id              String          @id @default(cuid())
  numero          String          @unique // Formato: AGC-2024-00001
  
  // Relação com utilizador (opcional para convidados)
  userId          String?
  user            User?           @relation(fields: [userId], references: [id])
  
  // Dados do cliente (sempre preenchidos, mesmo para utilizadores registados)
  clienteNome     String
  clienteEmail    String
  clienteTelefone String?
  
  // Endereço de entrega (snapshot JSON)
  enderecoEntrega String          // JSON armazenado como String para compatibilidade SQLite
  
  // Itens do pedido
  itens           ItemPedido[]
  
  // Valores monetários (em AOA)
  // Usar Float em vez de Decimal para compatibilidade SQLite
  subtotal        Float
  taxaEntrega     Float           @default(0)
  desconto        Float           @default(0)
  total           Float
  
  // Pagamento
  metodoPagamento String          // Enum como String para compatibilidade
  referenciaPagamento String?     // Referência Multicaixa ou bancária
  comprovativoUrl String?         // URL do comprovativo (se upload)
  
  // Estado actual
  estado          String          @default("PENDENTE") // Enum como String
  estadoHistorico EstadoHistorico[]
  
  // Fatura
  faturaNumero    String?         @unique // Formato: FT-2024-00001
  faturaGeradaEm  DateTime?
  faturaUrl       String?         // URL do PDF da fatura
  
  // Código de rastreio público
  codigoRastreio  String          @unique @default(cuid())
  
  // Notas
  notasCliente    String?         // Notas do cliente no checkout
  notasInternas   String?         // Notas internas (admin)
  
  // Timestamps
  criadoEm        DateTime        @default(now())
  pagoEm          DateTime?
  preparadoEm     DateTime?
  enviadoEm       DateTime?
  entregueEm      DateTime?
  canceladoEm     DateTime?
  
  updatedAt       DateTime        @updatedAt
  
  @@index([userId])
  @@index([estado])
  @@index([criadoEm])
  @@index([numero])
  @@index([codigoRastreio])
}

model ItemPedido {
  id           String  @id @default(cuid())
  pedidoId     String
  pedido       Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  
  // Snapshot do produto no momento da compra
  produtoId    String
  produtoSlug  String
  produtoNome  String
  produtoPreco Float   // Float em vez de Decimal
  produtoImagem String?
  produtoUnidade String @default("unidade")
  
  quantidade   Int
  subtotal     Float   // Float em vez de Decimal
  
  @@index([pedidoId])
}

model EstadoHistorico {
  id        String       @id @default(cuid())
  pedidoId  String
  pedido    Pedido       @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  
  estado    String       // Enum como String
  nota      String?      // Nota opcional sobre a mudança de estado
  criadoPor String?      // ID do admin ou "sistema"
  
  criadoEm  DateTime     @default(now())
  
  @@index([pedidoId])
}

// ==================== PRODUTOS ====================

model Produto {
  id          String   @id @default(cuid())
  slug        String   @unique
  nome        String
  descricao   String?
  preco       Float    // AOA
  unidade     String   // kg, unidade, maço, etc.
  categoriaId String
  categoria   Categoria @relation(fields: [categoriaId], references: [id])
  imagens     String[] // URLs do Supabase Storage
  stock       Int      @default(0)
  activo      Boolean  @default(true)
  destaque    Boolean  @default(false)
  produtor    String?  // Nome do produtor
  origem      String?  // Província de origem
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([categoriaId])
  @@index([activo])
  @@index([destaque])
}

model Categoria {
  id        String    @id @default(cuid())
  slug      String    @unique
  nome      String
  descricao String?
  imagem    String?
  ordem     Int       @default(0)
  activa    Boolean   @default(true)
  produtos  Produto[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@index([activa])
  @@index([ordem])
}

model Configuracao {
  id        String   @id @default(cuid())
  chave     String   @unique
  valor     String   // JSON para valores complexos
  descricao String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== ENUMS ====================
enum UserRole {
  CUSTOMER
  FARMER
  ADMIN
}